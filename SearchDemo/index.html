<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>SearchDemo | 聪哥的技术笔记</title><link rel="stylesheet" type="text/css" href="/WangCongBlog/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/WangCongBlog/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/WangCongBlog/favicon.ico"><link rel="apple-touch-icon" href="/WangCongBlog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/WangCongBlog/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">SearchDemo</h1><a id="logo" href="/WangCongBlog/.">聪哥的技术笔记</a><p class="description">科技是一种生活。——比特网</p></div><div id="nav-menu"><a class="current" href="/WangCongBlog/."><i class="fa fa-home"> Start</i></a><a href="/WangCongBlog/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/WangCongBlog/about/"><i class="fa fa-user"> Über</i></a><a href="/WangCongBlog/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">SearchDemo</h1><div class="post-meta">Mar 19, 2019</div><div class="post-content"><p>完整的站内搜索Demo(Lucene.Net+盘古分词)<br>前言<br>       各位朋友,谢谢大家的支持,由于文件过大,有考虑到版权的问题,故没有提供下载,本人已建立一个搜索技术交流群：77570783,源代码已上传至群共享,需要的朋友,请自行下载！</p>
<pre><code>首先自问自答几个问题,以让各位看官了解写此文的目的
</code></pre><p>什么是站内搜索？与一般搜索的区别？<br>很多网站都有搜索功能,很多都是用SQL语句的Like实现的,但是Like无法做到模糊匹配（例如我搜索“.net学习”,如果有“.net的学习”,Like就无法搜索到，这明显不符合需求,但是站内搜索就能做到）,另外Like会造成全盘扫描,会对数据库造成很大压力，为什么不用数据库全文检索，跟普通SQL一样,很傻瓜,灵活性不行</p>
<p>为什么不用百度、google的站内搜索？<br>毕竟是别人的东西,用起来肯定会受制于人（哪天你的网站火了,它看你不爽了,就可能被K）,主要还是索引的不够及时,网站新的内容,需要一定时间才能被索引到,并且用户的体验也不太好</p>
<pre><code>最近改造了《动力起航》的站内搜索的功能,它其实已经有站内搜索的功能,但是是用like来实现的,改造此功能是本着在尽可能少的修改网站的源代码的情况下去改造此功能以及此站内搜索功能可以很好的移植到其他项目的原则来编写！本文有借鉴其他大神及园友的技术,在此谢谢！
</code></pre><p>功能简介<br>站内搜索使用的技术<br>Log4Net  日志记录</p>
<p>lucene.Net   全文检索开发包,只能检索文本信息</p>
<p>分词（lucene.Net提供StandardAnalyzer一元分词,按照单个字进行分词,一个汉字一个词）</p>
<p>盘古分词   基于词库的分词,可以维护词库</p>
<p>具体详解<br>      首先我们新增的SearchHelper类需要将其做成一个单例,使用单例是因为：有许多地方需要使用使用，但我们同时又希望只有一个对象去操作,具体代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#region 创建单例</span><br><span class="line">        // 定义一个静态变量来保存类的实例</span><br><span class="line">        private static SearchHelper uniqueInstance;</span><br><span class="line"></span><br><span class="line">        // 定义一个标识确保线程同步</span><br><span class="line">        private static readonly object locker = new object();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        // 定义私有构造函数，使外界不能创建该类实例</span><br><span class="line">        private SearchHelper()</span><br><span class="line">        &#123; &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 定义公有方法提供一个全局访问点,同时你也可以定义公有属性来提供全局访问点</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">        public static SearchHelper GetInstance()</span><br><span class="line">        &#123;</span><br><span class="line">            // 当第一个线程运行到这里时，此时会对locker对象 &quot;加锁&quot;，</span><br><span class="line">            // 当第二个线程运行该方法时，首先检测到locker对象为&quot;加锁&quot;状态，该线程就会挂起等待第一个线程解锁</span><br><span class="line">            // lock语句运行完之后（即线程运行完之后）会对该对象&quot;解锁&quot;</span><br><span class="line">            lock (locker)</span><br><span class="line">            &#123;</span><br><span class="line">                // 如果类的实例不存在则创建，否则直接返回</span><br><span class="line">                if (uniqueInstance == null)</span><br><span class="line">                &#123;</span><br><span class="line">                    uniqueInstance = new SearchHelper();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return uniqueInstance;</span><br><span class="line">        &#125;</span><br><span class="line">        #endregion</span><br></pre></td></tr></table></figure>
<pre><code>其次,使用Lucene.Net需要将被搜索的进行索引,然后保存到索引库以便被搜索,我们引入了“生产者,消费者模式”. 生产者就是当我们新增,修改或删除的时候我们就需要将其在索引库进行相应的操作,我们将此操作交给另一个线程去处理,这个线程就是我们的消费者,使用“生产者,消费者模式”是因为:索引库使用前需解锁操作,使用完成之后必须解锁,所以只能有一个对象对索引库进行操作,避免数据混乱,所以要使用生产者，消费者模式
</code></pre><p>首先我们来看生产者，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private Queue&lt;IndexJob&gt; jobs = new Queue&lt;IndexJob&gt;();       //任务队列,保存生产出来的任务和消费者使用,不使用list避免移除时数据混乱问题</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 任务类,包括任务的Id ,操作的类型</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        class IndexJob</span><br><span class="line">        &#123;</span><br><span class="line">            public int Id &#123; get; set; &#125;</span><br><span class="line">            public JobType JobType &#123; get; set; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 枚举,操作类型是增加还是删除</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        enum JobType &#123; Add, Remove &#125;</span><br><span class="line">        #region 任务添加</span><br><span class="line">        public void AddArticle(int artId)</span><br><span class="line">        &#123;</span><br><span class="line">            IndexJob job = new IndexJob();</span><br><span class="line">            job.Id = artId;</span><br><span class="line">            job.JobType = JobType.Add;</span><br><span class="line">            logger.Debug(artId + &quot;加入任务列表&quot;);</span><br><span class="line">            jobs.Enqueue(job);//把任务加入商品库</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void RemoveArticle(int artId)</span><br><span class="line">        &#123;</span><br><span class="line">            IndexJob job = new IndexJob();</span><br><span class="line">            job.JobType = JobType.Remove;</span><br><span class="line">            job.Id = artId;</span><br><span class="line">            logger.Debug(artId + &quot;加入删除任务列表&quot;);</span><br><span class="line">            jobs.Enqueue(job);//把任务加入商品库</span><br><span class="line">        &#125;</span><br><span class="line">        #endregion</span><br></pre></td></tr></table></figure></p>
<p>下面是消费者,消费者我们单独一个线程来进行任务的处理：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">        /// 索引任务线程</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        private void IndexOn()</span><br><span class="line">        &#123;</span><br><span class="line">            logger.Debug(&quot;索引任务线程启动&quot;);</span><br><span class="line">            while (true)</span><br><span class="line">            &#123;</span><br><span class="line">                if (jobs.Count &lt;= 0)</span><br><span class="line">                &#123;</span><br><span class="line">                    Thread.Sleep(5 * 1000);</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //创建索引目录</span><br><span class="line">                if (!System.IO.Directory.Exists(IndexDic))</span><br><span class="line">                &#123;</span><br><span class="line">                    System.IO.Directory.CreateDirectory(IndexDic);</span><br><span class="line">                &#125;</span><br><span class="line">                FSDirectory directory = FSDirectory.Open(new DirectoryInfo(IndexDic), new NativeFSLockFactory());</span><br><span class="line">                bool isUpdate = IndexReader.IndexExists(directory);</span><br><span class="line">                logger.Debug(&quot;索引库存在状态&quot; + isUpdate);</span><br><span class="line">                if (isUpdate)</span><br><span class="line">                &#123;</span><br><span class="line">                    //如果索引目录被锁定（比如索引过程中程序异常退出），则首先解锁</span><br><span class="line">                    if (IndexWriter.IsLocked(directory))</span><br><span class="line">                    &#123;</span><br><span class="line">                        logger.Debug(&quot;开始解锁索引库&quot;);</span><br><span class="line">                        IndexWriter.Unlock(directory);</span><br><span class="line">                        logger.Debug(&quot;解锁索引库完成&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                IndexWriter writer = new IndexWriter(directory, new PanGuAnalyzer(), !isUpdate, Lucene.Net.Index.IndexWriter.MaxFieldLength.UNLIMITED);</span><br><span class="line">                ProcessJobs(writer);</span><br><span class="line">                writer.Close();</span><br><span class="line">                directory.Close();//不要忘了Close，否则索引结果搜不到</span><br><span class="line">                logger.Debug(&quot;全部索引完毕&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        private void ProcessJobs(IndexWriter writer)</span><br><span class="line">        &#123;</span><br><span class="line">            while (jobs.Count != 0)</span><br><span class="line">            &#123;</span><br><span class="line">                IndexJob job = jobs.Dequeue();</span><br><span class="line">                writer.DeleteDocuments(new Term(&quot;number&quot;, job.Id.ToString()));</span><br><span class="line">                //如果“添加文章”任务再添加，</span><br><span class="line">                if (job.JobType == JobType.Add)</span><br><span class="line">                &#123;</span><br><span class="line">                    BLL.article bll = new BLL.article();</span><br><span class="line">                    Model.article art = bll.GetArticleModel(job.Id);</span><br><span class="line">                    if (art == null)//有可能刚添加就被删除了</span><br><span class="line">                    &#123;</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line"></span><br><span class="line">                    string channel_id = art.channel_id.ToString();</span><br><span class="line">                    string title = art.title;</span><br><span class="line">                    DateTime time = art.add_time;</span><br><span class="line">                    string content = Utils.DropHTML(art.content.ToString());</span><br><span class="line">                    string Addtime = art.add_time.ToString(&quot;yyyy-MM-dd&quot;);</span><br><span class="line"></span><br><span class="line">                    Document document = new Document();</span><br><span class="line">                    //只有对需要全文检索的字段才ANALYZED</span><br><span class="line">                    document.Add(new Field(&quot;number&quot;, job.Id.ToString(), Field.Store.YES, Field.Index.NOT_ANALYZED));</span><br><span class="line">                    document.Add(new Field(&quot;title&quot;, title, Field.Store.YES, Field.Index.ANALYZED, Lucene.Net.Documents.Field.TermVector.WITH_POSITIONS_OFFSETS));</span><br><span class="line">                    document.Add(new Field(&quot;channel_id&quot;, channel_id, Field.Store.YES, Field.Index.NOT_ANALYZED));</span><br><span class="line">                    document.Add(new Field(&quot;Addtime&quot;, Addtime, Field.Store.YES, Field.Index.NOT_ANALYZED));</span><br><span class="line">                    document.Add(new Field(&quot;content&quot;, content, Field.Store.YES, Field.Index.ANALYZED, Lucene.Net.Documents.Field.TermVector.WITH_POSITIONS_OFFSETS));</span><br><span class="line">                    writer.AddDocument(document);</span><br><span class="line">                    logger.Debug(&quot;索引&quot; + job.Id + &quot;完毕&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        #endregion</span><br></pre></td></tr></table></figure></p>
<p>以上我们就把索引库建立完毕了,接下来就是进行搜索了,搜索操作里面包括对搜索关键词进行分词,其次是搜索内容搜索词高亮显示,下面就是搜索的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">#region 从索引搜索结果</span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 从索引搜索结果</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        public List&lt;Model.article&gt; SearchIndex(string Words, int PageSize, int PageIndex, out int _totalcount)</span><br><span class="line">        &#123;</span><br><span class="line">            _totalcount = 0;</span><br><span class="line">            Dictionary&lt;string, string&gt; dic = new Dictionary&lt;string, string&gt;();</span><br><span class="line">            BooleanQuery bQuery = new BooleanQuery();</span><br><span class="line">            string title = string.Empty;</span><br><span class="line">            string content = string.Empty;</span><br><span class="line">            title = GetKeyWordsSplitBySpace(Words);</span><br><span class="line">            QueryParser parse = new QueryParser(Lucene.Net.Util.Version.LUCENE_29, &quot;title&quot;, new PanGuAnalyzer());</span><br><span class="line">            Query query = parse.Parse(title);</span><br><span class="line">            parse.SetDefaultOperator(QueryParser.Operator.AND);</span><br><span class="line">            bQuery.Add(query, BooleanClause.Occur.SHOULD);</span><br><span class="line">            dic.Add(&quot;title&quot;, Words);</span><br><span class="line"></span><br><span class="line">            content = GetKeyWordsSplitBySpace(Words);</span><br><span class="line">            QueryParser parseC = new QueryParser(Lucene.Net.Util.Version.LUCENE_29, &quot;content&quot;, new PanGuAnalyzer());</span><br><span class="line">            Query queryC = parseC.Parse(content);</span><br><span class="line">            parseC.SetDefaultOperator(QueryParser.Operator.AND);</span><br><span class="line">            bQuery.Add(queryC, BooleanClause.Occur.SHOULD);</span><br><span class="line">            dic.Add(&quot;content&quot;, Words);</span><br><span class="line">            if (bQuery != null &amp;&amp; bQuery.GetClauses().Length &gt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                return GetSearchResult(bQuery, dic, PageSize, PageIndex, out _totalcount);</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 获取</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;bQuery&quot;&gt;&lt;/param&gt;</span><br><span class="line">        private List&lt;Model.article&gt; GetSearchResult(BooleanQuery bQuery, Dictionary&lt;string, string&gt; dicKeywords, int PageSize, int PageIndex, out int totalCount)</span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;Model.article&gt; list = new List&lt;Model.article&gt;();</span><br><span class="line">            FSDirectory directory = FSDirectory.Open(new DirectoryInfo(IndexDic), new NoLockFactory());</span><br><span class="line">            IndexReader reader = IndexReader.Open(directory, true);</span><br><span class="line">            IndexSearcher searcher = new IndexSearcher(reader);</span><br><span class="line">            TopScoreDocCollector collector = TopScoreDocCollector.create(1000, true);</span><br><span class="line">            Sort sort = new Sort(new SortField(&quot;Addtime&quot;, SortField.DOC, true));</span><br><span class="line">            searcher.Search(bQuery, null, collector);</span><br><span class="line">            totalCount = collector.GetTotalHits();//返回总条数</span><br><span class="line">            TopDocs docs = searcher.Search(bQuery, (Filter)null, PageSize * PageIndex, sort);</span><br><span class="line">            if (docs != null &amp;&amp; docs.totalHits &gt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                for (int i = 0; i &lt; docs.totalHits; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    if (i &gt;= (PageIndex - 1) * PageSize &amp;&amp; i &lt; PageIndex * PageSize)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Document doc = searcher.Doc(docs.scoreDocs[i].doc);</span><br><span class="line">                        Model.article model = new Model.article()</span><br><span class="line">                        &#123;</span><br><span class="line">                            id = int.Parse(doc.Get(&quot;number&quot;).ToString()),</span><br><span class="line">                            title = doc.Get(&quot;title&quot;).ToString(),</span><br><span class="line">                            content = doc.Get(&quot;content&quot;).ToString(),</span><br><span class="line">                            add_time = DateTime.Parse(doc.Get(&quot;Addtime&quot;).ToString()),</span><br><span class="line">                            channel_id = int.Parse(doc.Get(&quot;channel_id&quot;).ToString())</span><br><span class="line">                        &#125;;</span><br><span class="line">                        list.Add(SetHighlighter(dicKeywords, model));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return list;</span><br><span class="line">        &#125;</span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 设置关键字高亮</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;dicKeywords&quot;&gt;关键字列表&lt;/param&gt;</span><br><span class="line">        /// &lt;param name=&quot;model&quot;&gt;返回的数据模型&lt;/param&gt;</span><br><span class="line">        /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">        private Model.article SetHighlighter(Dictionary&lt;string, string&gt; dicKeywords, Model.article model)</span><br><span class="line">        &#123;</span><br><span class="line">            SimpleHTMLFormatter simpleHTMLFormatter = new PanGu.HighLight.SimpleHTMLFormatter(&quot;&lt;font color=\&quot;red\&quot;&gt;&quot;, &quot;&lt;/font&gt;&quot;);</span><br><span class="line">            Highlighter highlighter = new PanGu.HighLight.Highlighter(simpleHTMLFormatter, new Segment());</span><br><span class="line">            highlighter.FragmentSize = 250;</span><br><span class="line">            string strTitle = string.Empty;</span><br><span class="line">            string strContent = string.Empty;</span><br><span class="line">            dicKeywords.TryGetValue(&quot;title&quot;, out strTitle);</span><br><span class="line">            dicKeywords.TryGetValue(&quot;content&quot;, out strContent);</span><br><span class="line">            if (!string.IsNullOrEmpty(strTitle))</span><br><span class="line">            &#123;</span><br><span class="line">                string title = model.title;</span><br><span class="line">                model.title = highlighter.GetBestFragment(strTitle, model.title);</span><br><span class="line">                if (string.IsNullOrEmpty(model.title))</span><br><span class="line">                &#123;</span><br><span class="line">                    model.title = title;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (!string.IsNullOrEmpty(strContent))</span><br><span class="line">            &#123;</span><br><span class="line">                string content = model.content;</span><br><span class="line">                model.content = highlighter.GetBestFragment(strContent, model.content);</span><br><span class="line">                if (string.IsNullOrEmpty(model.content))</span><br><span class="line">                &#123;</span><br><span class="line">                    model.content = content;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return model;</span><br><span class="line">        &#125;</span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 处理关键字为索引格式</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;keywords&quot;&gt;&lt;/param&gt;</span><br><span class="line">        /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">        private string GetKeyWordsSplitBySpace(string keywords)</span><br><span class="line">        &#123;</span><br><span class="line">            PanGuTokenizer ktTokenizer = new PanGuTokenizer();</span><br><span class="line">            StringBuilder result = new StringBuilder();</span><br><span class="line">            ICollection&lt;WordInfo&gt; words = ktTokenizer.SegmentToWordInfos(keywords);</span><br><span class="line">            foreach (WordInfo word in words)</span><br><span class="line">            &#123;</span><br><span class="line">                if (word == null)</span><br><span class="line">                &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                result.AppendFormat(&quot;&#123;0&#125;^&#123;1&#125;.0 &quot;, word.Word, (int)Math.Pow(3, word.Rank));</span><br><span class="line">            &#125;</span><br><span class="line">            return result.ToString().Trim();</span><br><span class="line">        &#125; </span><br><span class="line">        #endregion</span><br></pre></td></tr></table></figure></p>
<p>以上我们的站内搜索的SearchHelper类就建立好了,下面来讲讲如何使用,此类提供以下几个方法对外使用：</p>
<p>在Global里面启动消费者线程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protected void Application_Start(object sender, EventArgs e)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            //启动索引库的扫描线程（生产者）</span><br><span class="line">            SearchHelper.GetInstance().CustomerStart();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>在需被搜索的新增或修改处添加下面方法:</p>
<p>SearchHelper.GetInstance().AddArticle(model.id);<br>在需被搜索的删除处添加下面方法:</p>
<p>SearchHelper.GetInstance().RemoveArticle(model.id);<br>搜索的时候使用下面的方法即可：</p>
<p>public List&lt;Model.article&gt; SearchIndex(string Words, int PageSize, int PageIndex, out int _totalcount)<br> 结束语<br>       以上就是整个站内搜索的全部代码,SearchHelper帮助类下载地址：<a href="http://files.cnblogs.com/beimeng/SearchHelper.rar" target="_blank" rel="noopener">http://files.cnblogs.com/beimeng/SearchHelper.rar</a></p>
</div><div class="tags"><a href="/WangCongBlog/tags/ASP-NET/">ASP.NET</a><a href="/WangCongBlog/tags/搜索技术/">搜索技术</a></div><div class="post-nav"><a class="pre" href="/WangCongBlog/TransferValue/">TransferValue</a><a class="next" href="/WangCongBlog/DotNET-IO/">DotNET_IO</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://wanglecongress.github.io/WangCongBlog"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/WangCongBlog/tags/git/" style="font-size: 15px;">git</a> <a href="/WangCongBlog/tags/项目管理/" style="font-size: 15px;">项目管理</a> <a href="/WangCongBlog/tags/微信/" style="font-size: 15px;">微信</a> <a href="/WangCongBlog/tags/Web编程/" style="font-size: 15px;">Web编程</a> <a href="/WangCongBlog/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/WangCongBlog/tags/服务器/" style="font-size: 15px;">服务器</a> <a href="/WangCongBlog/tags/云计算/" style="font-size: 15px;">云计算</a> <a href="/WangCongBlog/tags/ASP-NET/" style="font-size: 15px;">ASP.NET</a> <a href="/WangCongBlog/tags/搜索技术/" style="font-size: 15px;">搜索技术</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/Elasticsearch/">Elasticsearch</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/Cache/">asp.net缓存(转载）</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/TransferValue/">TransferValue</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/SearchDemo/">SearchDemo</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/DotNET-IO/">DotNET_IO</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/005_WeiFuWu/">什么是微服务？</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/004_MSSQL/">MSSQL</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/003_ASPDotNET/">ASP.NET</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/001_Github/">玩转Github之论Git与Github的正确打开方式</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/002_WeChat/">微信的公众号和小程序怎么来的，了解一下？</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/WangCongBlog/." rel="nofollow">聪哥的技术笔记.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/WangCongBlog/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/WangCongBlog/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/WangCongBlog/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/WangCongBlog/js/smartresize.js?v=0.0.0"></script></div></body></html>