<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>asp.net缓存(转载） | 聪哥的技术笔记</title><link rel="stylesheet" type="text/css" href="/WangCongBlog/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/WangCongBlog/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/WangCongBlog/favicon.ico"><link rel="apple-touch-icon" href="/WangCongBlog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/WangCongBlog/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">asp.net缓存(转载）</h1><a id="logo" href="/WangCongBlog/.">聪哥的技术笔记</a><p class="description">科技是一种生活。——比特网</p></div><div id="nav-menu"><a class="current" href="/WangCongBlog/."><i class="fa fa-home"> 首页</i></a><a href="/WangCongBlog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/WangCongBlog/about/"><i class="fa fa-user"> 关于</i></a><a href="/WangCongBlog/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">asp.net缓存(转载）</h1><div class="post-meta">Mar 19, 2019</div><div class="post-content"><p>由于工作的需要，最近对.net缓存做了相关了解和学习。做以下分类：</p>
<p>客户端缓存<br>第三方的缓存<br>服务器缓存</p>
<h4 id="客户端缓存"><a href="#客户端缓存" class="headerlink" title="客户端缓存"></a>客户端缓存</h4><p>客户端缓存主要是指浏览器帮我们缓存一些页面组件包括脚本，样式，图片等等，由于客户端缓存的原因，可以减少HTTP请求的次数，相关文章可以参阅性能探索（1-6）。浏览器缓存</p>
<h4 id="第三方缓存"><a href="#第三方缓存" class="headerlink" title="第三方缓存"></a>第三方缓存</h4><p>目前主要了解过memcached，它是通过在内存中开辟一块区域来维护一个hash表以加快页面的访问速度，和数据库是相对独立的。</p>
<p>和asp.net本是的缓存机制相比，memcached是一个分布式缓存系统，任何web服务器都能更新或删除缓存项，并且其他所有其他的服务器都能在下次访问时检测到这些更新。memcached已经提供了asp.net的客户端。</p>
<p>相关参考文章</p>
<p>利用memcached构建高性能的Web应用程序<br>memcached完全剖析<br>分布式缓存系统Memcached简介与实践<br>Memcached深度分析<br>自己实现memcached客户端库<br>Memcached使用点滴<br>.NET中使用Memcached的相关资源整理</p>
<h3 id="本文主要总结asp-net的服务器缓存"><a href="#本文主要总结asp-net的服务器缓存" class="headerlink" title="本文主要总结asp.net的服务器缓存"></a>本文主要总结asp.net的服务器缓存</h3><p>传统缓存（将数据放入Application或Session等变量中）<br>页面输出缓存<br>利用asp.net提高的System.Web.Caching实现缓存<br>缓存依赖</p>
<h4 id="服务器缓存—传统缓存"><a href="#服务器缓存—传统缓存" class="headerlink" title="服务器缓存—传统缓存"></a>服务器缓存—传统缓存</h4><p>对于一些在系统中被所有用户共享，可以重复，并且变动很小的数据我们可以将其放入Application或者Session中去，比如系统菜单数据，可以在Application_Start事件中将数据放入Application中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void Application_Start(object sender, EventArgs e)</span><br><span class="line">&#123;</span><br><span class="line">      Application[“SysMenu”]=MenuUtility.RetrieveMenuData();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样以后就对整个系统，所有用户共享，完全不要再去访问DB：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if(Application[“SysMenu”]!=null)//已经在缓存中，无需读取DB</span><br><span class="line">&#123;</span><br><span class="line">     menuData=Application[“SysMenu”] as DataSet;</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">menuData=MenuUtility.RetrieveMenuData();//缓存中不存在</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="服务器缓存—页面输出缓存"><a href="#服务器缓存—页面输出缓存" class="headerlink" title="服务器缓存—页面输出缓存"></a>服务器缓存—页面输出缓存</h4><p>这是.net 中最简单的缓存机制，该机制是将使用了页面输出缓存的页面存储在服务器内存中，当用户请求该页面时，直接从内存中输出页面，而无需再次经过页面生命周期（知道缓存数据过期）。</p>
<p>页面输出缓存应该用在那些不需要经常修改，但是需要经过大量的处理才能完成页面上面，其使用非常简单，只需在aspx页面顶部添加声明：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ OutputCache  Duration=&quot;60&quot; VaryByParam=&quot;none&quot; %&gt;</span><br></pre></td></tr></table></figure></p>
<p>它主要有一些参数，Duration，VaryByParam,VaryByConyrol等</p>
<p>Duration，这是必选属性，没有会爆出运行时错误，指缓存的时间（秒），在上面的例子中是60（60秒后缓存失效）。<br>VaryByParam，是指页面根据POST或GET发送的名称/值对来更新缓存的内容，多个参数使用逗号隔开，如果不希望根据如何参数更新缓存那么将其设置为none（上例），如果系统通过所有的参数值的改变来更新缓存，将其设置为*.<br>例如对于<a href="http://localhost/test.aspx?p=1,可以在test.aspx中设置" target="_blank" rel="noopener">http://localhost/test.aspx?p=1,可以在test.aspx中设置</a>&lt;%@ OutputCache  Duration=”60” VaryByParam=”p” %&gt;,当p=1时，60秒内数据会缓存，当p=2时又会执行后台代码更新缓存内容。<br>VaryByConyrol，是指通过当前页面中服务器控件来改变缓存（值是控件的ID，多个控件用分号隔开）<br>还有很多参数比如CacheProfle，Location等等：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ OutputCache Duration=&quot;#ofseconds&quot;  </span><br><span class="line"> Location=&quot;Any | Client | Downstream | Server | None | ServerAndClient &quot;   </span><br><span class="line">Shared=&quot;True | False&quot;   </span><br><span class="line">VaryByControl=&quot;controlname&quot;   </span><br><span class="line">VaryByCustom=&quot;browser | customstring&quot;  </span><br><span class="line"> VaryByHeader=&quot;headers&quot;   VaryByParam=&quot;parametername&quot;    </span><br><span class="line">CacheProfile=&quot;cache profile name | &apos;&apos;&quot;  </span><br><span class="line">NoStore=&quot;true | false&quot;   </span><br><span class="line">SqlDependency=&quot;database/table name pair | CommandNotification&quot;%&gt;</span><br></pre></td></tr></table></figure></p>
<p>具体可以查阅msdn .</p>
<h4 id="服务器缓存—利用asp-net提供的System-Web-Caching实现缓存"><a href="#服务器缓存—利用asp-net提供的System-Web-Caching实现缓存" class="headerlink" title="服务器缓存—利用asp.net提供的System.Web.Caching实现缓存"></a>服务器缓存—利用asp.net提供的System.Web.Caching实现缓存</h4><p>System.Web.Caching.Cache类是一个字典，可以存储任意对象，提高了失效功能，可以移除添加等，一个小例子说明一下。</p>
<p>缓存工具类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class CacheUtility</span><br><span class="line">&#123;</span><br><span class="line">    public CacheUtility()&#123;&#125;</span><br><span class="line"> </span><br><span class="line">    public static void SetCache(string key, object value)</span><br><span class="line">    &#123;</span><br><span class="line">        HttpRuntime.Cache.Insert(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public static void SetCache(string key, object value, DateTime absoluteExpiration, TimeSpan slidingExpiration)</span><br><span class="line">    &#123;</span><br><span class="line">        HttpRuntime.Cache.Insert(key, value, null, absoluteExpiration, slidingExpiration);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public static object RetrieveCacheValueByKey(string key)</span><br><span class="line">    &#123;</span><br><span class="line">        return HttpRuntime.Cache[key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>缓存使用方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">protected void Page_Load(object sender, EventArgs e)</span><br><span class="line">    &#123;</span><br><span class="line">        string key = &quot;key&quot;;</span><br><span class="line">        object obj = CacheUtility.RetrieveCacheValueByKey(key);</span><br><span class="line">        if (obj == null)</span><br><span class="line">        &#123;</span><br><span class="line">            obj = DateTime.Now;</span><br><span class="line"> </span><br><span class="line">            CacheUtility.SetCache(key, obj, DateTime.Now.AddMinutes(1), TimeSpan.Zero);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        object testObj = obj;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这些方法都能解决数据缓存问题，但是有一个很大的弊端，就是如果数据发生了变化，而缓存中的数据已经是过期的数据，只有等缓存过期后才能获取到最新的数据，这样会早晨数据的不一致，有些可能会早晨很严重的后果，比如说股票数据，怎么办？缓存依赖出场。</p>
<p>服务器缓存—缓存依赖<br>在上面出的代码HttpRuntime.Cache.Insert(key, value, null, absoluteExpiration, slidingExpiration);这里面有个参数是null，这个参数就是缓存依赖参数。</p>
<p>缓存依赖的类为System.Web.Caching.CacheDependency.</p>
<p>.net缓存依赖主要分为为两种：<br>文件缓存依赖<br>数据库缓存依赖</p>
<p>服务器缓存—文件缓存依赖<br>该策略让缓存依赖于一个指定的文件，通过文件的更新日期来清楚缓存，加入某些数据是来自于xml文件，那么完全可以将该xml数据的缓存依赖于该xml文件，只要xml文件改变，则自动清空依赖其的数据缓存。例子：</p>
<p>重构一个SetCache用于设置文件依赖：</p>
<p>public static void SetCache(string key, object value, System.Web.Caching.CacheDependency cacheDependency)<br>   {<br>       HttpRuntime.Cache.Insert(key, value, cacheDependency,<br>           System.Web.Caching.Cache.NoAbsoluteExpiration,<br>           System.Web.Caching.Cache.NoSlidingExpiration);<br>   }<br>设置文件依赖，并设置缓存</p>
<p>protected void Page_Load(object sender, EventArgs e)<br>   {<br>       string key = “key”;<br>       object obj = CacheUtility.RetrieveCacheValueByKey(key);<br>       if (obj == null)<br>       {<br>           obj = DateTime.Now;<br>           System.Web.Caching.CacheDependency cacheDependency = new System.Web.Caching.CacheDependency(“C:\dependencyText.txt”);<br>           CacheUtility.SetCache(key, obj, cacheDependency);<br>       }</p>
<pre><code>object testObj = obj;
</code></pre><p>   }<br>这样当我们改变dependencyText.txt的内容时，缓存就会自动更新，这种方式非常适合于读取配置文件等一些xml数据。</p>
<p>服务器缓存—数据库缓存依赖<br>其实我们服务器的大多性能损耗还是花在查询数据库的时候，所以对于数据库的缓存是特别重要的，如果我们的缓存能够依赖于数据库数据的变化就会更好，其实.net已经实现了这个机制：System.Web.Caching.SqlCacheDependency，该类就是.net专门为数据库缓存依赖而设计的，它继承自CacheDependency。<br>public sealed class SqlCacheDependency : CacheDependency<br>  {<br>      public SqlCacheDependency(SqlCommand sqlCmd);</p>
<pre><code>public SqlCacheDependency(string databaseEntryName, string tableName);

public static CacheDependency CreateOutputCacheDependency(string dependency);
protected override void DependencyDispose();

public override string GetUniqueID();
</code></pre><p>  }<br>对于数据库缓存依赖需要对数据库和网站做一些配置，petshop4.0讲非常的清楚，本人在学习之余转载文章一篇，可谓是相当出彩，本文在此就不再多说，具体可以点此查看</p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/WangCongBlog/Elasticsearch/">Elasticsearch</a><a class="next" href="/WangCongBlog/TransferValue/">TransferValue</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://wanglecongress.github.io/WangCongBlog"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/WangCongBlog/tags/服务器/" style="font-size: 15px;">服务器</a> <a href="/WangCongBlog/tags/云计算/" style="font-size: 15px;">云计算</a> <a href="/WangCongBlog/tags/git/" style="font-size: 15px;">git</a> <a href="/WangCongBlog/tags/项目管理/" style="font-size: 15px;">项目管理</a> <a href="/WangCongBlog/tags/微信/" style="font-size: 15px;">微信</a> <a href="/WangCongBlog/tags/Web编程/" style="font-size: 15px;">Web编程</a> <a href="/WangCongBlog/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/WangCongBlog/tags/ASP-NET/" style="font-size: 15px;">ASP.NET</a> <a href="/WangCongBlog/tags/搜索技术/" style="font-size: 15px;">搜索技术</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/Elasticsearch/">Elasticsearch</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/Cache/">asp.net缓存(转载）</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/TransferValue/">TransferValue</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/SearchDemo/">SearchDemo</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/DotNET-IO/">DotNET_IO</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/005_WeiFuWu/">什么是微服务？</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/004_MSSQL/">MSSQL</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/003_ASPDotNET/">ASP.NET</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/001_Github/">玩转Github之论Git与Github的正确打开方式</a></li><li class="post-list-item"><a class="post-list-link" href="/WangCongBlog/002_WeChat/">微信的公众号和小程序怎么来的，了解一下？</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/WangCongBlog/." rel="nofollow">聪哥的技术笔记.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/WangCongBlog/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/WangCongBlog/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/WangCongBlog/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/WangCongBlog/js/smartresize.js?v=0.0.0"></script></div></body></html>